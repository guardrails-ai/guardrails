name: Integration / Server Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  GUARDRAILS_TEST_IMAGE: "guardrails-server:ci"

jobs:
  integration:
    name: Build & Test Server Image
    runs-on: ubuntu-latest

    steps:
      - name: Check out head
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Load Guardrails Hub token from 1Password
        if: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN != '' }}
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          GUARDRAILS_TOKEN: ${{ secrets.GUARDRAILS_API_KEY_OP_PATH }}

      - name: Validate Guardrails Hub token loaded
        run: |
          set -euo pipefail
          if [ -z "${GUARDRAILS_TOKEN:-}" ]; then
            echo "GUARDRAILS_TOKEN is not set. Configure either 1Password (OP_SERVICE_ACCOUNT_TOKEN + GUARDRAILS_API_KEY_OP_PATH) or provide GUARDRAILS_TOKEN as an Actions secret." >&2
            exit 1
          fi

      - name: Build Docker image
        uses: ./.github/actions/build-guardrails-server
        with:
          tags: ${{ env.GUARDRAILS_TEST_IMAGE }}
          platforms: linux/amd64
          push: "false"
          load: "true"
          python_version: ${{ env.PYTHON_VERSION }}
          variant: "slim"
          version: ${{ github.sha }}
          commit: ${{ github.sha }}
          oci_source: ${{ github.server_url }}/${{ github.repository }}
          oci_vendor: ${{ github.repository_owner }}
          oci_authors: ${{ github.repository_owner }}

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --group dev --all-packages

      - name: Run integration tests
        env:
          GUARDRAILS_TOKEN: ${{ env.GUARDRAILS_TOKEN }}
          GUARDRAILS_EXTENSIONS: "guardrails/two_words"
          GUARDRAILS_TEST_IMAGE: ${{ env.GUARDRAILS_TEST_IMAGE }}
        run: uv run pytest tests/integration_tests/server -v --tb=short -m integration
