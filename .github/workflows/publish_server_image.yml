name: Publish Server Image

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (don't actually push)"
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  packages: write
  attestations: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GUARDRAILS_EXTENSIONS: "hub://guardrails/detect_pii,hub://guardrails/toxic_language"

jobs:
  publish:
    name: Build & Push (py${{ matrix.python_version }}-${{ matrix.variant }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python_version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        variant: ["slim"]

    continue-on-error: ${{ matrix.python_version == '3.14' }}

    steps:
      - name: Check out head
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: ${{ github.event_name != 'workflow_dispatch' || !inputs.dry_run }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Guardrails Hub token from 1Password
        if: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN != '' }}
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          GUARDRAILS_API_KEY: ${{ secrets.GUARDRAILS_API_KEY_OP_PATH }}

      - name: Validate Guardrails Hub token loaded
        run: |
          set -euo pipefail
          if [ -z "${GUARDRAILS_API_KEY:-}" ]; then
            echo "GUARDRAILS_API_KEY is not set. Configure either 1Password (OP_SERVICE_ACCOUNT_TOKEN + GUARDRAILS_API_KEY_OP_PATH) or provide GUARDRAILS_API_KEY as an Actions secret." >&2
            exit 1
          fi

      - name: Compute image tags
        id: tags
        run: |
          set -euo pipefail

          image="ghcr.io/kubedoll-heavy-industries/guardrails"
          ref_name="${{ github.ref_name }}"
          py="${{ matrix.python_version }}"
          variant="${{ matrix.variant }}"

          tags="${image}:${ref_name}-${variant}-py${py}"
          if [ "${py}" = "3.12" ] && [ "${variant}" = "slim" ]; then
            tags="${tags}\n${image}:${ref_name}-${variant}"
            tags="${tags}\n${image}:${ref_name}"
          fi

          {
            echo "image=${image}"
            echo "tags<<EOF"
            echo -e "${tags}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push server image
        uses: ./.github/actions/build-guardrails-server
        with:
          tags: ${{ steps.tags.outputs.tags }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'workflow_dispatch' || !inputs.dry_run }}
          load: "false"
          python_version: ${{ matrix.python_version }}
          variant: ${{ matrix.variant }}
          guardrails_extensions: ${{ env.GUARDRAILS_EXTENSIONS }}
          version: ${{ github.ref_name }}
          commit: ${{ github.sha }}
          oci_source: ${{ github.server_url }}/${{ github.repository }}
          oci_vendor: ${{ github.repository_owner }}
          oci_authors: ${{ github.repository_owner }}
          guardrails_token: ${{ env.GUARDRAILS_API_KEY }}
